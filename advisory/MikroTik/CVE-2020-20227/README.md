### CVE-2020-20227

#### Description

The `diskd` process suffers from a memory corruption vulnerability. By sending a crafted packet, an authenticated remote user can crash the `diskd` process due to invalid memory access.

Against stable `6.47`, the poc resulted in the following crash captured by `gdb`.

```shell
(gdb) c
Continuing.

Program received signal SIGSEGV, Segmentation fault.
=> 0x7775a1e3 <_ZN6string6assignERKS_+21>:      mov    eax,DWORD PTR [eax]
   0x7775a1e5 <_ZN6string6assignERKS_+23>:      mov    edx,DWORD PTR [eax]
   0x7775a1e7 <_ZN6string6assignERKS_+25>:      add    edx,eax
   0x7775a1e9 <_ZN6string6assignERKS_+27>:      add    edx,0x4
0x7775a1e3 in string::assign(string const&) () from target:/lib/libuc++.so
(gdb) i r
eax            0xa      10
ecx            0x8054600        134563328
edx            0x8056e18        134573592
ebx            0x777624ec       2004231404
esp            0x7f9dceac       0x7f9dceac
ebp            0x7f9dceb8       0x7f9dceb8
esi            0xa      10
edi            0x7f9dd024       2141048868
eip            0x7775a1e3       0x7775a1e3 <string::assign(string const&)+21>
eflags         0x10202  [ IF RF ]
cs             0x73     115
ss             0x7b     123
ds             0x7b     123
es             0x7b     123
fs             0x0      0
gs             0x33     51
(gdb) info inferiors
  Num  Description       Executable
* 1    process 119       target:/nova/bin/diskd
```

And the crash dump in `/rw/logs/backtrace.log` was:

```shell
# cat /rw/logs/backtrace.log 
2020.06.05-15:00:38.33@0: 
2020.06.05-15:00:38.33@0: 
2020.06.05-15:00:38.33@0: /nova/bin/diskd
2020.06.05-15:00:38.33@0: --- signal=11 --------------------------------------------
2020.06.05-15:00:38.33@0: 
2020.06.05-15:00:38.33@0: eip=0x7775a1e3 eflags=0x00010202
2020.06.05-15:00:38.33@0: edi=0x7f9dd024 esi=0x0000000a ebp=0x7f9dceb8 esp=0x7f9dceac
2020.06.05-15:00:38.33@0: eax=0x0000000a ebx=0x777624ec ecx=0x08054600 edx=0x08056e18
2020.06.05-15:00:38.33@0: 
2020.06.05-15:00:38.33@0: maps:
2020.06.05-15:00:38.33@0: 08048000-08052000 r-xp 00000000 00:0c 1049       /nova/bin/diskd
2020.06.05-15:00:38.33@0: 776ff000-77734000 r-xp 00000000 00:0c 966        /lib/libuClibc-0.9.33.2.so
2020.06.05-15:00:38.33@0: 77738000-77752000 r-xp 00000000 00:0c 962        /lib/libgcc_s.so.1
2020.06.05-15:00:38.33@0: 77753000-77762000 r-xp 00000000 00:0c 945        /lib/libuc++.so
2020.06.05-15:00:38.33@0: 77763000-7776b000 r-xp 00000000 00:0c 951        /lib/libubox.so
2020.06.05-15:00:38.33@0: 7776c000-777b8000 r-xp 00000000 00:0c 947        /lib/libumsg.so
2020.06.05-15:00:38.33@0: 777be000-777c5000 r-xp 00000000 00:0c 960        /lib/ld-uClibc-0.9.33.2.so
2020.06.05-15:00:38.33@0: 
2020.06.05-15:00:38.33@0: stack: 0x7f9de000 - 0x7f9dceac 
2020.06.05-15:00:38.33@0: f4 8a 7b 77 0a 00 00 00 f4 8a 7b 77 e8 ce 9d 7f 92 be 78 77 f8 45 05 08 0a 00 00 00 18 6e 05 08 
2020.06.05-15:00:38.33@0: 18 6e 05 08 e4 ce 9d 7f 24 d0 9d 7f 7c 18 76 77 24 d0 9d 7f 18 69 05 08 40 cf 9d 7f a8 cf 9d 7f 
2020.06.05-15:00:38.34@0: 
2020.06.05-15:00:38.34@0: code: 0x7775a1e3
2020.06.05-15:00:38.34@0: 8b 00 8b 10 01 c2 83 c2 04 52 83 c0 04 50 ff 75 
```

#### Affected Version

This vulnerability was initially found in stable  `6.47`, and it was fixed at least in stable `6.48.1`.

#### Timeline

+ 2020/08/04 - report the vulnerability to the vendor
+ 2020/08/05 - vendor require more information to re-compile the provided poc source file
+ 2020/08/05 - provide the cmake file to vendor
+ 2020/08/06 - vendor repeat and confirm the vulnerability
+ 2021/03/01 - re-test against stable `6.48.1`, and it was fixed in this version (no response from the vendor indicating if this vulnerability has been fixed, and in which version it was fixed)
+ 2021/05/04 - CVE is assigned

